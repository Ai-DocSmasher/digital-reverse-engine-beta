import numpy as npimport librosadef true_reverse(audio: np.ndarray, sample_rate: int, **kwargs):    return audio[::-1]def _hann_window(length: int):    return np.hanning(length).astype(np.float32)def grain_reverse(    audio: np.ndarray,    sample_rate: int,    grain_size_ms: float = 60.0,    overlap: float = 0.5,    **kwargs):    grain_size = int(sample_rate * grain_size_ms / 1000.0)    grain_size = max(grain_size, 128)    hop = int(grain_size * (1.0 - overlap))    hop = max(hop, 1)    window = _hann_window(grain_size)    out = np.zeros_like(audio, dtype=np.float32)    norm = np.zeros_like(audio, dtype=np.float32)    n = len(audio)    pos = 0    while pos < n:        end = min(pos + grain_size, n)        grain = audio[pos:end]        if len(grain) < grain_size:            pad = grain_size - len(grain)            grain = np.pad(grain, (0, pad))        grain = grain[::-1] * window        out[pos:pos + grain_size] += grain[: n - pos]        norm[pos:pos + grain_size] += window[: n - pos]        pos += hop    norm[norm == 0] = 1.0    out /= norm    return out.astype(np.float32)def transientaware_reverse(    audio: np.ndarray,    sample_rate: int,    transient_threshold: float = 0.3,    min_spacing_ms: float = 15.0,    **kwargs):    # Convert stereo â†’ mono for analysis    if audio.ndim > 1:        audio_mono = audio.mean(axis=1)    else:        audio_mono = audio    # Onset detection on mono    onset_env = librosa.onset.onset_strength(y=audio_mono, sr=sample_rate)    onsets = librosa.onset.onset_detect(        onset_envelope=onset_env,        sr=sample_rate,        backtrack=True,        pre_max=3,        post_max=3,        pre_avg=3,        post_avg=3,        delta=transient_threshold,        units="time",    )    if len(onsets) == 0:        return true_reverse(audio, sample_rate)    onset_samples = (onsets * sample_rate).astype(int)    onset_samples = np.clip(onset_samples, 0, len(audio_mono) - 1)    # Minimum spacing    min_spacing = int(min_spacing_ms * sample_rate / 1000.0)    filtered = []    last = 0